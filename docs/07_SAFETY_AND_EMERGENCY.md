# 07 — 緊急時通信・オフライン耐性・エラーリカバリ

## 1. 緊急時通信設計

### 1.1 緊急度レベルの定義

| レベル | 状況例 | 必要応答時間 | トリガー方法 |
|---|---|---|---|
| 致命的 | 呼吸困難、窒息 | 即座 | パッシブ検出 + 自動通報 |
| 高 | 激しい痛み、吸引必要 | 10秒以内 | トリプルタップ or 緊急候補選択 |
| 中 | トイレ、体勢変更 | 1分以内 | 通常の候補選択 |
| 低 | 寒い/暑い、テレビ操作 | 数分以内 | 通常の候補選択 |

### 1.2 緊急コールの発動方法

```
方法1: トリプルタップ（指が動く場合）
  → 即座に緊急画面を表示
  → 緊急カテゴリを1タップで選択
  → 介護者全員に通知

方法2: まばたき3連打（指が動かない場合）
  → 3秒以内に意図的な強いまばたきを3回検出
  → 誤検出防止: 確認画面を表示（2秒以内にまばたき1回で確定）

方法3: パッシブ緊急検出（意識があるが操作できない場合）
  → バイタル異常（SpO2低下、心拍異常）
  → 表情の急激な変化（苦痛パターン検出）
  → 視線が固定したまま動かない（意識レベル低下の兆候）
  → 自動で介護者に通知（患者には確認を求めない）
```

### 1.3 緊急画面

```
┌──────────────────────────────┐
│         ⚠️ 緊急通報          │
│                              │
│  ┌────────┐  ┌────────┐     │
│  │呼吸困難 │  │激しい痛み│    │
│  │        │  │        │     │
│  └────────┘  └────────┘     │
│  ┌────────┐  ┌────────┐     │
│  │吸引必要 │  │人を呼んで│    │
│  │        │  │        │     │
│  └────────┘  └────────┘     │
│                              │
│      [キャンセル（2連タップ）] │
└──────────────────────────────┘

選択 → 即座に:
  1. 介護者全員にプッシュ通知（音+バイブ）
  2. スマートスピーカーがあればアラーム音
  3. 患者画面に「通報しました」と表示
  4. 介護者が確認するまでアラート継続
```

### 1.4 誤報対策

```
誤報軽減策:
  - トリプルタップの間隔を1秒以内に限定
  - まばたき3連打は「強いまばたき」のみカウント（通常のまばたきは除外）
  - パッシブ検出は30秒間の持続的異常で発動（瞬間的な変動では発動しない）
  - 緊急画面には常に[キャンセル]オプションを表示

誤報時の対応:
  - 介護者がアプリで「誤報」をマーク
  - 誤報パターンを学習し、閾値を自動調整
  - 誤報が頻発する場合、設定画面で感度を手動調整可能
```

---

## 2. オフライン耐性設計

### 2.1 オフライン時の機能レベル

| 機能 | オンライン | オフライン | 備考 |
|---|---|---|---|
| 緊急コール | ✅ | ✅（ローカル通知） | BLE/WiFi Direct で直接通知 |
| 定型文選択 | ✅ | ✅ | ローカルに定型文DB保持 |
| 視線追跡 | ✅ | ✅ | 完全ローカル処理 |
| 指入力 | ✅ | ✅ | 完全ローカル処理 |
| 文字入力 | ✅ | ✅ | 予測変換はオンデバイスLLM |
| AI候補生成（高品質） | ✅ | ❌ → 縮退版 | オンデバイスLLMで代替 |
| リスニングモード | ✅ | ⚠️（精度低下） | オンデバイスASRで代替 |
| PVP活用候補 | ✅ | ⚠️（品質低下） | オンデバイスLLM + PVP |
| 環境認識（VLM） | ✅ | ❌ | オフライン時は無効化 |
| 介護者通知 | ✅（プッシュ） | ⚠️（ローカル） | 同一WiFi内のみ |

### 2.2 オフラインアーキテクチャ

```
┌─────────────────────────────────────────────┐
│             患者端末（オフライン時）           │
│                                             │
│  [常時動作（ローカル）]                       │
│   ├ 視線推定エンジン                         │
│   ├ 指入力処理                               │
│   ├ まばたき検出                             │
│   ├ 感情検出（ベースラインベース）             │
│   └ UI表示                                   │
│                                             │
│  [縮退動作]                                  │
│   ├ オンデバイスLLM（Phi-3 / Llama-3-8B等）  │
│   │  → PVP込みの候補生成（品質は低下）        │
│   ├ オンデバイスASR（Whisper tiny/small）     │
│   │  → リスニングモード（精度低下）           │
│   └ ローカル定型文DB                         │
│       → 頻出フレーズ500件をプリロード         │
│                                             │
│  [無効化]                                    │
│   ├ VLMによるシーン認識                      │
│   └ クラウドLLMによる高品質候補              │
│                                             │
│  [ローカル通知]                              │
│   ├ BLE → 介護者スマートウォッチ             │
│   ├ WiFi Direct → 介護者スマートフォン       │
│   └ 音声アラート（スピーカー出力）            │
└─────────────────────────────────────────────┘
```

### 2.3 データ同期

```
オフライン → オンライン復帰時:
  1. オフライン中の会話ログをクラウドに同期
  2. PVP更新データがあれば反映
  3. オンデバイスLLMの候補をクラウドLLMに切替
  4. 介護者への未送信通知を再送
```

---

## 3. エラーリカバリ設計

### 3.1 誤選択のリカバリ

```
問題: 意図しない候補を選択してしまった

対策1: 確定前プレビュー
  チラ見 + タップ
    → 候補がハイライト表示（0.8秒間）
    → この間にもう1タップで本確定
    → タップしなければ自動キャンセル

対策2: 直後キャンセル
  確定後2秒以内にダブルタップ → 取り消し
  音声合成が開始していた場合は即停止
  介護者画面に「訂正中」と表示

対策3: 訂正発話
  誤発話後に「違う、○○」と正しい候補を選択
  介護者画面に訂正履歴を表示

フロー:
  タップ → [0.8秒プレビュー] → タップで確定 → [2秒キャンセル猶予] → 発話
```

### 3.2 不随意運動によるミスタップ対策

```
対策1: 視線ゲーティング
  - 視線がUI上の候補ゾーンにない場合、タップを無視
  - 設定で ON/OFF 可能（視線追跡精度が低い場合はOFF）

対策2: 圧力波形フィルタ
  - 不随意運動は不規則で小さい振動パターン
  - 意図的タップは明確な立ち上がりと立ち下がり
  - 波形パターンで分類（個人適応あり）

対策3: タイムアウト
  - タップ後0.8秒以内に視線が候補から離れた場合、無効とする
```

### 3.3 システム障害時のフォールバック

```
障害レベル1: 視線追跡の精度低下
  → ゾーン数を自動削減（9→4→2）
  → 指入力のみのモードを提示

障害レベル2: カメラが使用不能
  → 指入力のみのモードに切替
  → 定型文リストをスクロール（タップ/ダブルタップで操作）

障害レベル3: 指センサーが使用不能
  → Dwell Clickモードにフォールバック（従来方式）
  → まばたき入力モード

障害レベル4: ネットワーク断絶
  → オフラインモードに自動切替（上記2.2参照）

障害レベル5: 電源断
  → UPS（無停電電源装置）推奨
  → バッテリー残量20%でアラート
  → 5%で自動的に緊急コールのみのモードに
```

---

## 4. 長文コミュニケーション設計

### 4.1 短文モード vs 長文モード

```
短文モード（デフォルト）:
  - 会話用。1〜2文の発話を生成
  - 候補選択UIで操作

長文モード:
  - 手紙、メール、医師への説明等
  - LLMに下書きを書かせ、患者が承認/修正するコラボレーション型
```

### 4.2 長文モードのフロー

```
1. 患者が長文モードを選択（メニューから）

2. 目的を指定
   [メール] [手紙] [医師への説明] [SNS投稿] [その他]

3. 相手を指定
   [花子] [田中先生] [太郎] [自由入力]

4. トピック/キーワードを入力（2ストローク方式 or 候補選択）
   例: "背中" "痛い" "3日前から"

5. LLMがPVPベースで下書きを生成
   "田中先生、お世話になっています。3日前から背中に
    痛みがあり、特に夜間に強くなります。
    体勢を変えても改善しません。次回の診察で
    ご相談させてください。よろしくお願いいたします。"

6. 患者が確認
   [OK] [部分修正] [書き直し]

7. 部分修正の場合:
   修正箇所をゾーン選択 → 修正候補を提示 → 選択
   例: "夜間に" → ["午後から", "食後に", "寝返り時に"]

8. 確定 → 送信 or 音声読み上げ
```

---

## 5. 複数人会話への対応

### 5.1 対話相手の指定

```
部屋に複数人いる場合:

方法1: 視線方向
  患者が見ている方向に誰がいるかを外部カメラで検出
  → その人向けのスタイルで候補生成

方法2: 明示的切替
  候補表示エリアの端に対話相手インジケーターを表示
  "花子" ← [切替] → "看護師A"

方法3: 「みんなに」モード
  全員向けの発話として処理。最もフォーマルなスタイルを適用。
```

### 5.2 グループ会話での短い相槌

複数人が会話している場面では、長い発言より短い相槌の方が自然。

```
グループ会話検出時の候補傾向:
  - 短い相槌を優先: "そうだね" "うん" "へぇ"
  - 笑い: "笑" "ははは"
  - 同意/驚き: "それはすごい" "ほんとに？"
  - 質問（短い）: "いつ？" "誰？" "なんで？"

通常時よりも候補の文を短くし、テンポよく返せるようにする。
```
