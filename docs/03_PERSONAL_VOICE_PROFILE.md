# 03 — Personal Voice Profile（PVP）の抽出と活用

## 1. PVPの目的

Personal Voice Profile（PVP）は、患者の文体・語彙・思考パターン・対人スタイルを構造化した個人プロファイルである。ファインチューニングではなく、推論時のIn-Context Learningにより「その人らしさ」を再現する。

### なぜファインチューニングではないか

| 観点 | ファインチューニング | PVP + ICL |
|---|---|---|
| 更新容易性 | モデル再訓練が必要 | テキスト更新のみ |
| モデル依存 | 特定モデルに固定 | 任意のLLMで利用可能 |
| データ量 | 大量のペアデータが必要 | 数百件の文例で十分 |
| 可搬性 | モデルごと移動が必要 | JSONファイル1つで移動可能 |
| 透明性 | ブラックボックス | プロファイルを人間が確認・編集可能 |
| コスト | GPU時間が必要 | 追加コスト不要 |

---

## 2. PVPのデータ構造

```yaml
personal_voice_profile:
  version: "1.0"
  patient_id: "xxx-xxx"
  last_updated: "2026-02-17T14:00:00+09:00"
  data_sources:
    - type: "gmail"
      records: 1250
      date_range: "2018-01 ~ 2025-06"
    - type: "line"
      records: 8400
      date_range: "2020-03 ~ 2025-08"
    - type: "voice_recording"
      hours: 12.5
      date_range: "2024-01 ~ 2025-03"

  # ===== Section 1: 語彙と表現の癖 =====
  vocabulary:
    preferred_expressions:
      - pattern: "感謝"
        typical: "ありがとね"
        context: "家族に対して。フォーマルな場では「ありがとうございます」"
      - pattern: "謝罪"
        typical: "ごめんね" / "悪いね"
        avoids: "すみません"（ほとんど使わない）
      - pattern: "同意"
        typical: "そうだよね" / "だよなぁ"
      - pattern: "体調報告"
        typical: "まあまあ" / "ぼちぼち"
        note: "深刻でも軽めに答える傾向"

    sentence_endings:
      casual: ["〜だよね", "〜かな", "〜だなぁ", "〜じゃん"]
      neutral: ["〜ですね", "〜だと思います"]
      emphasis: ["〜だよ！", "〜でしょ！"]
      frequency_note: "疑問形の語尾が多い。断定を避ける傾向。"

    fillers_and_openers:
      - "そうだなぁ"（考え始め）
      - "あ、そういえば"（話題転換時）
      - "ちょっと"（依頼の前置き）
      - "なんかさ"（カジュアルな話題導入）

    word_choices:
      - domain: "食事"
        preferences: "ごはん（「食事」とは言わない）、うまい（「美味しい」より多用）"
      - domain: "体調"
        preferences: "しんどい（「辛い」より多用）、だるい、きつい"

  # ===== Section 2: 思考パターン =====
  thinking_patterns:
    structure:
      - "結論を先に言わず、背景や経緯から話し始める"
      - "「〜だけど、でも〜」のように一度譲歩してから本題に入る"
      - "相手の気持ちへの言及を必ず含める"
    reasoning_style:
      - "具体例をよく使う（「たとえば〜」が多い）"
      - "数字や事実を根拠にする傾向（エンジニア出身）"
    humor:
      - "自虐的なユーモアが多い"
      - "ダジャレは言わない"
      - "相手を笑わせようとする場面：緊張をほぐしたいとき"

  # ===== Section 3: 対人スタイル =====
  relational_styles:
    - relation: "wife"
      name: "花子"
      tone: "casual, warm, slightly playful"
      characteristics:
        - "遠慮なく要望を伝える"
        - "感謝は短くても必ず添える"
        - "体調が悪くても心配させないよう明るく振る舞う"
      example_utterances:
        - "花子さん、ありがとね。無理しないでね"
        - "あ、ちょっとトイレお願い"
        - "今日も一日おつかれさま"

    - relation: "doctor"
      name: "田中先生"
      tone: "polite but direct, informative"
      characteristics:
        - "症状を正確に伝えようとする"
        - "質問は具体的"
        - "余計な世間話はしない"
      example_utterances:
        - "先生、左足の痺れが3日前から強くなっています"
        - "薬を飲んだ後、2時間くらいで効果が薄れる感じがします"

    - relation: "children"
      name: "太郎（孫）、美咲（娘）"
      tone: "playful, encouraging, proud"
      characteristics:
        - "褒めることが多い"
        - "冗談を言いたがる"
        - "成長を喜ぶ表現が多い"
      example_utterances:
        - "太郎すごいじゃん！"
        - "美咲に似て頭いいなぁ"

    - relation: "nurse"
      tone: "polite, appreciative, concise"
      characteristics:
        - "短く要件を伝える"
        - "必ずお礼を言う"
      example_utterances:
        - "吸引お願いします"
        - "ありがとうございます、助かります"

    - relation: "unknown"
      tone: "polite, neutral"
      default_style: "ですます調、丁寧だが堅すぎない"

  # ===== Section 4: 頻出トピックと定型表現 =====
  frequent_topics:
    daily_care:
      - category: "体位"
        expressions: ["体勢を少し右に", "背中がかゆい", "足を上げてほしい"]
      - category: "排泄"
        expressions: ["トイレお願い", "尿器お願い"]
      - category: "環境"
        expressions: ["エアコン下げて", "テレビ消して", "カーテン閉めて"]
      - category: "食事"
        expressions: ["水が欲しい", "もう少し食べたい", "もういい"]
      - category: "医療"
        expressions: ["吸引お願い", "薬の時間", "痛い"]
    emotional:
      - "ありがとう、助かるよ"
      - "大丈夫、心配しないで"
      - "今日は調子いいよ"
    interests:
      - topic: "野球"
        detail: "阪神タイガースファン。試合結果を気にする"
      - topic: "孫"
        detail: "太郎の学校の話を聞きたがる"
      - topic: "技術"
        detail: "元エンジニア。新しいガジェットに興味"

  # ===== Section 5: 避ける表現 =====
  avoidances:
    - "過度に弱気な表現（「もう無理」「死にたい」等は本人の意思に反する）"
    - "敬語過剰（家族に対して「〜していただけますか」等は不自然）"
    - "子供扱いされるような表現"
    - "直接的な不満表現（「嫌だ」より「ちょっと困るなぁ」を好む）"

  # ===== Section 6: 音声特性メモ =====
  voice_characteristics:
    pace: "ややゆっくり。考えながら話す"
    pitch: "中低音。落ち着いた声"
    laugh: "控えめだが頻繁。鼻で笑うことが多い"
    emotional_expression: "声のトーンよりも言葉選びで感情を表す"
```

---

## 3. 抽出パイプライン

### 3.1 全体フロー

```
[データソース群]
  ├→ Gmail API → 送信メール本文
  ├→ LINE トーク履歴エクスポート → テキスト
  ├→ SNS アーカイブ（X, Facebook）→ 投稿テキスト
  ├→ 音声録音 → ASR → テキスト + パラ言語特徴
  ├→ ブログ / 文書 → テキスト
  └→ 手紙（スキャン）→ OCR → テキスト

      ↓

[正規化層]
  各ソースのデータを統一フォーマットに変換
      ↓

[サンプリング層]
  相手別 × 時期別 × チャネル別にクラスタリング
  各クラスタから代表サンプルを抽出
      ↓

[パターン抽出層]（LLMによるバッチ処理）
  段階的に抽出:
    Round 1: 語彙・表現の癖
    Round 2: 思考パターン・論理構造
    Round 3: 対人スタイル（相手別）
    Round 4: トピック傾向・定型表現
    Round 5: 避ける表現・NGパターン
      ↓

[統合・圧縮層]
  各Roundの結果をマージし、重複排除・矛盾解消
  最終PVPを生成（~2000トークン以内）
      ↓

[検証層]
  家族/本人にPVPを提示して確認
  修正フィードバックを反映
```

### 3.2 データソース別コネクタ仕様

#### Gmail

```
取得方法: Gmail API（OAuth2認証）
対象: 送信メールのみ（受信メールは相手のデータ）
フィルタ:
  - 自動返信・不在通知を除外
  - テンプレート文面を除外
  - 一定文字数以下（10文字以下）を除外
抽出情報:
  - 本文テキスト
  - 宛先（相手の推定関係性）
  - 送信日時
  - 件名（話題の手がかり）
```

#### LINE

```
取得方法: トーク履歴エクスポート機能（テキストファイル）
対象: 患者本人の発言のみ抽出
フィルタ:
  - スタンプ/画像/動画の通知行を除外
  - URL共有のみの行を除外
抽出情報:
  - 発言テキスト
  - 相手名（トークルーム名から推定）
  - 日時
  - 前後の文脈（相手の発言も参考用に保持）
```

#### 音声録音

```
取得方法: 音声ファイル（WAV/MP3/M4A）を直接入力
処理:
  1. 話者分離（Speaker Diarization）→ 患者の発話区間を特定
  2. 音声認識（ASR）→ テキスト化
  3. パラ言語特徴量抽出:
     - 発話速度（WPM）
     - ピッチパターン（平均、分散、文末の上下）
     - ポーズの長さと頻度
     - 笑い声の頻度と種類
     - 声の大きさの変動
抽出情報:
  - テキスト + タイムスタンプ
  - パラ言語特徴メタデータ
  - 相手情報（手動アノテーション or 話者認識）
```

### 3.3 正規化フォーマット

```json
{
  "id": "msg_001",
  "source": "line",
  "timestamp": "2024-06-15T18:30:00+09:00",
  "patient_text": "今日は暑かったね。ビール飲みたいな",
  "recipient_relation": "wife",
  "recipient_name": "花子",
  "context": {
    "prior_messages": [
      {"speaker": "花子", "text": "ただいま〜、暑かった〜"}
    ]
  },
  "metadata": {
    "channel": "chat",
    "estimated_tone": "casual",
    "topic_tags": ["weather", "food_drink", "desire"]
  }
}
```

### 3.4 パターン抽出プロンプト（Round 1 例）

```
以下は{患者名}さんが{相手}に送ったメッセージ群です。
（{ソース名}、{期間}、{件数}件）

これらのメッセージから、{患者名}さんの語彙と表現の癖を抽出してください。

具体的には：
1. よく使う言い回し・フレーズ（5つ以上）
   - どういう場面で使うかも記述
2. 特徴的な語尾パターン（3つ以上）
3. 口癖・フィラー表現
4. 特定の単語の選好（例：「美味しい」vs「うまい」）
5. 避けている表現があれば

必ず原文からの引用例を添えてください。
引用は「」で囲み、どのメッセージからの引用か番号で示してください。

[メッセージデータ: 200件分]
```

---

## 4. PVPの運用

### 4.1 推論時のプロンプト構成

```
[System]
あなたは{患者名}さんの発話を代弁するアシスタントです。

{患者名}さんのPersonal Voice Profile:
---
{PVP全文（YAML形式、~2000トークン）}
---

以下のルールを厳守してください:
- {患者名}さんの語彙・語尾・表現の癖を忠実に再現する
- 対話相手に応じたスタイルを使い分ける
- avoidancesに記載された表現は絶対に使わない
- 候補はそれぞれ異なる「発話意図」を持つこと

[User]
現在の状況:
- 時刻: {timestamp}
- 対話相手: {recipient_name}（{relation}）
- 相手の直前の発話: "{last_speech}"
- 環境: {scene_description}
- 患者の状態: {patient_state}
- 直近の会話: {conversation_history}

{患者名}さんが返しそうな応答を4つ生成してください。
各候補に[意図タグ]を付けてください。
短い候補から順に並べてください。
```

### 4.2 PVPの更新サイクル

```
初期構築: 過去データからバッチ生成（1回）
    ↓
日次更新: その日の会話から新しいパターンを検出
    ↓
週次統合: 日次の差分をPVPに統合
    ↓
月次レビュー: 家族/本人による確認と修正
    ↓
随時更新: 明示的な修正リクエスト（「こうは言わない」等）
```

### 4.3 発症前データの重要性

PVP構築において発症前のデータを優先的に使う理由：

- 発症後は入力手段の制約で表現が簡略化されている可能性が高い
- 「本来のその人の声」は発症前の豊かな表現の中にある
- ただし、発症後の変化（新しい関心事、価値観の変化）も反映すべき

```
データ重み付け:
  発症前のデータ: 重み 1.0（語彙・表現パターンの基盤）
  発症後・入力制約前: 重み 0.8（話題や関心事の更新）
  発症後・入力制約後: 重み 0.5（意図は参考にするが表現は割引）
  現在の使用ログ: 重み 0.3（最新の好みを反映、ただしシステム依存の表現は除外）
```
